<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔋 Energy Saver Costa Rica - Sistema Modulare Avanzato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="text-6xl loading mb-4">⚡</div>
            <h2 class="text-2xl font-bold">Energy Saver Costa Rica</h2>
            <p class="text-lg opacity-80">Cargando sistema modulare...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="text-5xl mb-4">🔋</div>
                <h1 class="text-3xl font-bold text-gray-800">Energy Saver</h1>
                <p class="text-gray-600">Costa Rica - Sistema Avanzado</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" 
                           class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                           placeholder="tu@email.com" 
                           value="mariosavardenergysaver@gmail.com" required>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="login-password" 
                           class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                           placeholder="••••••••" 
                           value="mario123" required>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" id="remember-me" class="w-4 h-4 text-blue-600 rounded">
                    <label for="remember-me" class="ml-2 text-sm text-gray-600">Recordar sesión</label>
                </div>
                
                <button type="submit" id="login-btn" 
                        class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-lg hover:bg-blue-700 transition-all transform hover:scale-105">
                    🔑 Iniciar Sesión
                </button>
            </form>
            
            <div id="login-error" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <div class="text-2xl">🔋</div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Energy Saver Costa Rica</h1>
                            <p class="text-xs text-gray-500">Sistema Modulare Avanzado</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="user-info" class="text-right">
                            <div id="user-name" class="font-semibold text-gray-900"></div>
                            <div id="user-role" class="text-xs text-gray-500"></div>
                        </div>
                        <button id="logout-btn" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Salir
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button class="nav-tab active py-4 px-1 border-b-2 border-blue-500 text-blue-600 font-medium" data-tab="analysis">
                        📊 Nuevo Análisis
                    </button>
                    <button class="nav-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" data-tab="history">
                        📋 Historial
                    </button>
                    <button class="nav-tab py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" data-tab="admin">
                        👑 Admin
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Analysis Tab -->
            <div id="tab-analysis" class="tab-content">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-8">📊 Nuevo Análisis Energético</h2>
                    
                    <!-- Client Form -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre Completo *</label>
                            <input type="text" id="client-name" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   placeholder="Juan Pérez Rodríguez" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Teléfono *</label>
                            <input type="tel" id="client-phone" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   placeholder="8888-8888" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" id="client-email" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" 
                                   placeholder="cliente@email.com">
                        </div>
                    </div>

                    <!-- File Upload Simulation -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-4">Recibos Eléctricos</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors">
                            <div class="text-5xl mb-4">📄</div>
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Subir Recibos Eléctricos</h3>
                            <p class="text-gray-500 mb-4">JPG, PNG, PDF - Máximo 5MB por archivo</p>
                            <button type="button" id="simulate-upload" 
                                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                📁 Simular Carga de Archivos
                            </button>
                        </div>
                        <div id="files-status" class="mt-4 space-y-2"></div>
                    </div>

                    <!-- Analysis Button -->
                    <div class="text-center">
                        <button id="start-analysis" disabled
                                class="bg-green-600 text-white px-12 py-4 rounded-xl font-bold text-xl hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-105">
                            🚀 Realizar Análisis Energético
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-8">📋 Historial de Análisis</h2>
                    <div id="history-content">
                        <p class="text-gray-500 text-center py-8">No hay análisis previos</p>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="tab-admin" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-8">👑 Panel de Administración</h2>
                    <div id="admin-content">
                        <p class="text-gray-500 text-center py-8">Panel administrativo - En desarrollo</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Analysis Results Modal -->
    <div id="results-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-90vh overflow-y-auto">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">✅ Resultados del Análisis</h2>
                    <button id="close-results" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="results-content"></div>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="config/config.js"></script>
    <script src="modules/auth.js"></script>
    <script src="modules/analysis.js"></script>
    <script src="init.js"></script>

    <!-- Main App Script -->
    <script>
        // App state
        let uploadedFiles = [];
        let currentAnalysis = null;

        // Initialize app when DOM loaded
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Starting Energy Saver App...');
            
            // Initialize app
            const initResult = await EnergySaver.init();
            
            if (initResult.success) {
                hideLoading();
                checkAuthStatus();
                setupEventListeners();
            } else {
                console.error('❌ App initialization failed');
                showError('Error al inicializar la aplicación');
            }
        });

        // Auth functions
        function checkAuthStatus() {
            const authResult = EnergySaver.modules.auth.checkAuthStatus();
            if (authResult.success) {
                showDashboard(authResult.data);
            } else {
                showLogin();
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            const result = EnergySaver.login(email, password, rememberMe);
            
            if (result.success) {
                hideLoginError();
                showDashboard(result.data);
            } else {
                showLoginError(result.message);
            }
        }

        function handleLogout() {
            EnergySaver.logout();
            showLogin();
        }

        // UI functions
        function hideLoading() {
            document.getElementById('loading-screen').classList.add('hidden');
        }

        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard(user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-role').textContent = user.role.toUpperCase();
            
            // Show/hide admin tab based on role
            const adminTab = document.querySelector('[data-tab="admin"]');
            if (user.isAdmin) {
                adminTab.classList.remove('hidden');
            } else {
                adminTab.classList.add('hidden');
            }
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function hideLoginError() {
            document.getElementById('login-error').classList.add('hidden');
        }

        function showError(message) {
            alert('❌ ' + message); // TODO: Better error UI
        }

        // File simulation
        function simulateFileUpload() {
            uploadedFiles = [
                { name: 'recibo_enero.pdf', type: 'application/pdf', size: 1024 * 1024 },
                { name: 'recibo_febrero.jpg', type: 'image/jpeg', size: 2 * 1024 * 1024 },
                { name: 'recibo_marzo.png', type: 'image/png', size: 1.5 * 1024 * 1024 }
            ];
            
            displayUploadedFiles();
            checkAnalysisReady();
        }

        function displayUploadedFiles() {
            const statusEl = document.getElementById('files-status');
            statusEl.innerHTML = uploadedFiles.map(file => `
                <div class="flex items-center justify-between bg-green-50 border border-green-200 p-3 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <span class="text-green-600">✅</span>
                        <span class="font-medium">${file.name}</span>
                        <span class="text-sm text-gray-500">(${(file.size / 1024 / 1024).toFixed(1)} MB)</span>
                    </div>
                </div>
            `).join('');
        }

        function checkAnalysisReady() {
            const name = document.getElementById('client-name').value.trim();
            const phone = document.getElementById('client-phone').value.trim();
            const hasFiles = uploadedFiles.length > 0;
            
            document.getElementById('start-analysis').disabled = !(name && phone && hasFiles);
        }

        // Analysis functions
        async function performAnalysis() {
            const clientData = {
                nombre: document.getElementById('client-name').value.trim(),
                telefono: document.getElementById('client-phone').value.trim(),
                email: document.getElementById('client-email').value.trim()
            };

            console.log('🔄 Starting analysis...');
            
            // Show loading state
            const btn = document.getElementById('start-analysis');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Analizando...';
            btn.disabled = true;
            
            try {
                const result = await EnergySaver.analyzeEnergy(clientData, uploadedFiles);
                
                if (result.success) {
                    currentAnalysis = result.data;
                    showResults(result.data);
                } else {
                    showError(result.message);
                }
            } catch (error) {
                showError('Error durante el análisis: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function showResults(analysis) {
            const modal = document.getElementById('results-modal');
            const content = document.getElementById('results-content');
            
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-xl text-center">
                        <div class="text-3xl font-bold text-blue-600">${analysis.cliente.nombre}</div>
                        <div class="text-sm text-gray-600 mt-1">Cliente</div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl text-center">
                        <div class="text-3xl font-bold text-green-600">${analysis.equipoRecomendado.name}</div>
                        <div class="text-sm text-gray-600 mt-1">Equipo</div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-xl text-center">
                        <div class="text-3xl font-bold text-purple-600">₡${analysis.ahorroTotal.toLocaleString()}</div>
                        <div class="text-sm text-gray-600 mt-1">Ahorro/mes</div>
                    </div>
                    <div class="bg-yellow-50 p-6 rounded-xl text-center">
                        <div class="text-3xl font-bold text-yellow-600">${analysis.roiMeses}</div>
                        <div class="text-sm text-gray-600 mt-1">ROI meses</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-xl mb-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">📊 Resumen Detallado</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div><strong>Consumo actual:</strong> ${analysis.consumoPromedio} kWh/mes</div>
                        <div><strong>Factura actual:</strong> ₡${analysis.facturaPromedio.toLocaleString()}/mes</div>
                        <div><strong>Factor potencia:</strong> ${analysis.factorPotencia}</div>
                        <div><strong>Eficiencia:</strong> ${analysis.eficienciaActual}</div>
                        <div><strong>Ahorro energético:</strong> ₡${analysis.ahorroEnergetico.toLocaleString()}/mes</div>
                        <div><strong>Ahorro multas:</strong> ₡${analysis.ahorroMultas.toLocaleString()}/mes</div>
                        <div><strong>% de ahorro:</strong> ${analysis.porcentajeAhorro}%</div>
                        <div><strong>Flujo positivo:</strong> ₡${analysis.flujoPositivo.toLocaleString()}/mes</div>
                    </div>
                </div>
                
                <div class="flex space-x-4 justify-center">
                    <button onclick="generateDocument('pagare')" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">
                        📄 Generar PAGARÉ
                    </button>
                    <button onclick="shareWhatsApp()" 
                            class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600">
                        💬 Compartir
                    </button>
                    <button onclick="newAnalysis()" 
                            class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700">
                        🔄 Nuevo
                    </button>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function hideResults() {
            document.getElementById('results-modal').classList.add('hidden');
        }

        function generateDocument(type) {
            if (!currentAnalysis) return;
            
            if (type === 'pagare') {
                // Simple PAGARÉ generation
                const pagareContent = `
PAGARÉ - ENERGY SAVER COSTA RICA

Cliente: ${currentAnalysis.cliente.nombre}
Teléfono: ${currentAnalysis.cliente.telefono}
Monto: $${Math.floor(currentAnalysis.totalEquipo / CONFIG.financial.TC_BCCR).toLocaleString()} USD
Equipo: ${currentAnalysis.equipoRecomendado.name}
Fecha: ${new Date().toLocaleDateString('es-CR')}

Prima: $${currentAnalysis.equipoRecomendado.prima}
24 Cuotas: $${currentAnalysis.equipoRecomendado.cuotaUSD} c/u
Interés: 0%

${CONFIG.company.name}
${CONFIG.company.representante}
                `;
                
                const blob = new Blob([pagareContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PAGARE_${currentAnalysis.cliente.nombre.replace(/\s+/g, '_')}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert('✅ PAGARÉ generado y descargado');
            }
        }

        function shareWhatsApp() {
            if (!currentAnalysis) return;
            
            const message = `🔋 *ENERGY SAVER COSTA RICA*
📊 *ANÁLISIS ENERGÉTICO*

👤 Cliente: ${currentAnalysis.cliente.nombre}
🔧 Equipo: ${currentAnalysis.equipoRecomendado.name}
💰 Ahorro: ₡${currentAnalysis.ahorroTotal.toLocaleString()}/mes
⏱️ ROI: ${currentAnalysis.roiMeses} meses

¡Solicita tu análisis gratuito!
📞 ${CONFIG.company.telefono}`;

            const whatsappUrl = `https://wa.me/506${CONFIG.company.whatsapp.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function newAnalysis() {
            currentAnalysis = null;
            uploadedFiles = [];
            
            // Reset form
            document.getElementById('client-name').value = '';
            document.getElementById('client-phone').value = '';
            document.getElementById('client-email').value = '';
            document.getElementById('files-status').innerHTML = '';
            
            checkAnalysisReady();
            hideResults();
        }

        // Tab navigation
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // Activate nav tab
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            activeTab.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            
            // Load tab content
            if (tabName === 'history') {
                loadHistory();
            }
        }

        function loadHistory() {
            const history = EnergySaver.getAnalysisHistory();
            const content = document.getElementById('history-content');
            
            if (history.length === 0) {
                content.innerHTML = '<p class="text-gray-500 text-center py-8">No hay análisis previos</p>';
                return;
            }
            
            content.innerHTML = history.map(analysis => `
                <div class="border border-gray-200 rounded-lg p-4 mb-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${analysis.cliente.nombre}</h3>
                            <p class="text-sm text-gray-600">${analysis.fecha} | ${analysis.equipoRecomendado.name}</p>
                            <p class="text-sm text-green-600">Ahorro: ₡${analysis.ahorroTotal.toLocaleString()}/mes</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-semibold">${analysis.roiMeses} meses</div>
                            <div class="text-sm text-gray-500">ROI</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    switchTab(e.target.dataset.tab);
                });
            });
            
            // File upload simulation
            document.getElementById('simulate-upload').addEventListener('click', simulateFileUpload);
            
            // Analysis form
            document.getElementById('client-name').addEventListener('input', checkAnalysisReady);
            document.getElementById('client-phone').addEventListener('input', checkAnalysisReady);
            document.getElementById('start-analysis').addEventListener('click', performAnalysis);
            
            // Results modal
            document.getElementById('close-results').addEventListener('click', hideResults);
        }

        console.log('✅ Energy Saver App ready!');
    </script>
</body>
</html>
